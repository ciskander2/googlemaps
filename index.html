<!DOCTYPE html>
<html>
<head>
  <title>Smart Multi-Option Route Planner</title>
  <meta charset="utf-8"/>
  <meta name="viewport" content="initial-scale=1.0, width=device-width"/>
  <style>
    #map { height: 60vh; width: 100%; margin-bottom: 10px; }
    .controls { margin-bottom: 10px; }
    .controls input { width: 200px; margin-right: 6px; }
    .controls button { margin-right: 6px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #888; padding: 6px; text-align: center; white-space: nowrap; }
    th { background: #f0f0f0; }
    .legend span { margin-right: 15px; }
  </style>
</head>
<body>
  <div class="controls">
    <input id="origin" placeholder="Origin (e.g. Paris, FR)"/>
    <div id="waypoints"></div>
    <button id="add-stop">+ Add Stop</button>
    <input id="destination" placeholder="Destination (e.g. Los Angeles, CA)"/>
    <button id="go">Plot Route</button>
  </div>
  <div class="legend">
    <strong>Legend:</strong>
    <span style="color: #FF0000;">Plane</span> | 
    <span style="color: #0000FF;">Sea</span> | 
    <span style="color: #008000;">Drive</span> | 
    <span style="color: gold; font-weight: bold;">Greenest Route</span>
  </div>
  <div id="map"></div>
  <div id="summary"></div>

  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBcjGLzmaGgh_cgwoS_2eGas0LD9oQQdDw&libraries=places"></script>
  <script>
    // PORTS, EMISSION, calculateDistance, findNearestPort, detectContinent functions stay unchanged

    let map, directionsService, mapRenderers = [];

    function clearRoutes() {
      mapRenderers.forEach(r => r.setMap(null));
      mapRenderers = [];
      document.getElementById("summary").innerHTML = "";
    }

    function renderSegment(pathCoords, color, weight = 3) {
      const line = new google.maps.Polyline({
        path: pathCoords, geodesic: true, strokeColor: color,
        strokeOpacity: 1.0, strokeWeight: weight
      });
      line.setMap(map);
      mapRenderers.push(line);
    }

    function routeDriving(a, b, col, weight = 3) {
      const renderer = new google.maps.DirectionsRenderer({
        suppressMarkers: true,
        polylineOptions: { strokeColor: col, strokeWeight: weight }
      });
      renderer.setMap(map);
      directionsService.route({
        origin: a, destination: b, travelMode: "DRIVING"
      }, (res, status) => {
        if (status === "OK") renderer.setDirections(res);
      });
      mapRenderers.push(renderer);
    }

    function processRoute() {
      clearRoutes();
      const pts = [
        document.getElementById("origin").value,
        ...[...document.querySelectorAll(".waypoint")].map(i => i.value),
        document.getElementById("destination").value
      ];
      const geo = new google.maps.Geocoder();
      let coords = [], places = [];

      pts.reduce((p, loc) => {
        return p.then(() => new Promise((resolve, reject) => {
          geo.geocode({ address: loc }, (res, st) => {
            if (st === "OK") {
              coords.push(res[0].geometry.location.toJSON());
              places.push(res[0].formatted_address);
              resolve();
            } else {
              alert(`Failed geocode: ${loc}`); reject();
            }
          });
        }));
      }, Promise.resolve()).then(async () => {
        const summary = document.getElementById("summary");
        summary.innerHTML = `
          <h3>Route Summary</h3>
          <table><thead><tr>
            <th>From</th><th>To</th><th>Mode</th><th>Dist (km)</th><th>Time (hr)</th><th>CO₂ (kg)</th>
          </tr></thead><tbody>`;

        for (let i = 0; i < coords.length - 1; i++) {
          const start = coords[i];
          const end = coords[i + 1];
          const fromCity = places[i];
          const toCity = places[i + 1];
          const d = calculateDistance(start.lat, start.lng, end.lat, end.lng);
          const continentStart = detectContinent(start.lat, start.lng);
          const continentEnd = detectContinent(end.lat, end.lng);

          let routeVariants = [];
          const portA = findNearestPort(start);
          const portB = findNearestPort(end);

          if (d > 3000 && continentStart !== continentEnd) {
            const driveToPort = calculateDistance(start.lat, start.lng, portA.lat, portA.lng);
            const driveFromPort = calculateDistance(end.lat, end.lng, portB.lat, portB.lng);
            const segments = [];
            if (driveToPort > 20) segments.push({ m: "Driving", a: start, b: portA });
            segments.push({ m: "Sea", a: portA, b: portB });
            if (driveFromPort > 20) segments.push({ m: "Driving", a: portB, b: end });
            routeVariants.push(segments);
          }

          routeVariants.push([{ m: "Plane", a: start, b: end }]);
          routeVariants.push([{ m: "Driving", a: start, b: end }]);

          // Calculate CO2 totals for each variant
          let totals = routeVariants.map(segments => segments.reduce((sum, seg) => {
            const dist = calculateDistance(seg.a.lat, seg.a.lng, seg.b.lat, seg.b.lng);
            return sum + (dist * EMISSION[seg.m].factor);
          }, 0));

          let greenestIdx = totals.indexOf(Math.min(...totals));

          for (let optionIdx = 0; optionIdx < routeVariants.length; optionIdx++) {
            for (let seg of routeVariants[optionIdx]) {
              const md = calculateDistance(seg.a.lat, seg.a.lng, seg.b.lat, seg.b.lng);
              const sp = EMISSION[seg.m].speed;
              const tm = (md / sp).toFixed(2);
              const co = (md * EMISSION[seg.m].factor).toFixed(1);
              const isGreen = (optionIdx === greenestIdx);
              const color = isGreen ? "gold" : seg.m === "Plane" ? "#FF0000" : seg.m === "Sea" ? "#0000FF" : "#008000";
              const weight = isGreen ? 5 : 3;

              summary.innerHTML += `
                <tr>
                  <td>${fromCity}</td>
                  <td>${toCity}</td>
                  <td>${seg.m} (Option ${optionIdx + 1}${isGreen ? ' ⭐' : ''})</td>
                  <td>${md.toFixed(1)}</td>
                  <td>${tm}</td>
                  <td>${co}</td>
                </tr>`;

              if (seg.m === "Driving") routeDriving(seg.a, seg.b, color, weight);
              else renderSegment([seg.a, seg.b], color, weight);
            }
          }
        }

        summary.innerHTML += "</tbody></table>";
      });
    }

    document.getElementById("add-stop").addEventListener("click", () => {
      const div = document.createElement("div");
      div.innerHTML = `<input class="waypoint" placeholder="Waypoint"/> <button onclick="this.parentNode.remove()">✕</button>`;
      document.getElementById("waypoints").appendChild(div);
    });
    document.getElementById("go").addEventListener("click", processRoute);

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        zoom: 4, center: { lat: 39.5, lng: -98 }
      });
      directionsService = new google.maps.DirectionsService();
    }

    window.onload = initMap;
  </script>
</body>
</html>
