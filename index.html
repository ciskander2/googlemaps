<!DOCTYPE html>
<html>
<head>
  <title>Smart Multi-Option Route Planner</title>
  <meta charset="utf-8"/>
  <meta name="viewport" content="initial-scale=1.0, width=device-width"/>
  <style>
    #map { height: 60vh; width: 100%; margin-bottom: 10px; }
    .controls { margin-bottom: 10px; }
    .controls input { width: 200px; margin-right: 6px; }
    .controls button { margin-right: 6px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #888; padding: 6px; text-align: center; white-space: nowrap; }
    th { background: #f0f0f0; }
    .legend span { margin-right: 15px; }
  </style>
</head>
<body>
  <div class="controls">
    <input id="origin" placeholder="Origin (e.g. Paris, FR)"/>
    <div id="waypoints"></div>
    <button id="add-stop">+ Add Stop</button>
    <input id="destination" placeholder="Destination (e.g. Oklahoma City, OK)"/>
    <button id="go">Plot Route</button>
  </div>
  <div class="legend">
    <strong>Legend:</strong>
    <span style="color: #FF0000;">Plane</span> | 
    <span style="color: #0000FF;">Sea</span> | 
    <span style="color: #008000;">Drive</span>
  </div>
  <div id="map"></div>
  <div id="summary"></div>

  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBcjGLzmaGgh_cgwoS_2eGas0LD9oQQdDw&libraries=places"></script>
  <script>
    const PORTS = [
      { name: "Port of Le Havre", lat: 49.4949, lng: 0.1079 },
      { name: "Port of New York", lat: 40.7128, lng: -74.0060 },
      { name: "Port of Houston", lat: 29.7560, lng: -95.3678 },
      { name: "Port of Los Angeles", lat: 33.7361, lng: -118.2519 }
    ];

    const EMISSION = {
      Plane: { speed: 800, factor: 0.897 },
      Sea:   { speed: 35,  factor: 0.025 },
      Driving: { speed: 80, factor: 0.432 }
    };

    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2-lat1)*Math.PI/180;
      const dLon = (lon2-lon1)*Math.PI/180;
      const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function findNearestPort(coord) {
      let nearest = PORTS[0], best = Infinity;
      PORTS.forEach(p => {
        const d = calculateDistance(coord.lat, coord.lng, p.lat, p.lng);
        if (d < best) { best = d; nearest = p; }
      });
      return nearest;
    }

    function detectContinent(lat, lng) {
      if (lng >= -170 && lng <= -30 && lat > 5 && lat < 80) return "NorthAmerica";
      if (lng >= -10 && lng <= 60 && lat > 30 && lat < 75) return "Europe";
      return "Other";
    }

    window.onload = () => {
      let map, directionsService, mapRenderers = [];
      const summary = document.getElementById("summary");

      function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
          zoom: 4, center: { lat: 39.5, lng: -98 }
        });
        directionsService = new google.maps.DirectionsService();
      }

      function clearRoutes() {
        mapRenderers.forEach(r => r.setMap(null));
        mapRenderers = [];
        summary.innerHTML = "";
      }

      function renderSegment(pathCoords, color) {
        const line = new google.maps.Polyline({
          path: pathCoords, geodesic: true, strokeColor: color,
          strokeOpacity: 1.0, strokeWeight: 3
        });
        line.setMap(map);
        mapRenderers.push(line);
      }

      function routeDriving(a, b, col) {
        const renderer = new google.maps.DirectionsRenderer({
          suppressMarkers: true, polylineOptions: { strokeColor: col }
        });
        renderer.setMap(map);
        directionsService.route({
          origin: a, destination: b, travelMode: "DRIVING"
        }, (res, status) => {
          if (status === "OK") renderer.setDirections(res);
        });
        mapRenderers.push(renderer);
      }

      function processRoute() {
        clearRoutes();
        const pts = [
          document.getElementById("origin").value,
          ...[...document.querySelectorAll(".waypoint")].map(i => i.value),
          document.getElementById("destination").value
        ];
        const geo = new google.maps.Geocoder();
        let coords = [];

        pts.reduce((p, loc) => {
          return p.then(() => new Promise((y, n) => {
            geo.geocode({ address: loc }, (res, st) => {
              if (st === "OK") { coords.push(res[0].geometry.location.toJSON()); y(); }
              else { alert(`Failed geocode: ${loc}`); n(); }
            });
          }));
        }, Promise.resolve()).then(() => {
          summary.innerHTML = `<h3>Route Summary</h3><table>
          <tr><th>From</th><th>To</th><th>Mode</th><th>Dist (km)</th><th>Time (hr)</th><th>CO₂ (kg)</th></tr>`;

          coords.forEach((start, i) => {
            const end = coords[i+1];
            if (!end) return;

            const d = calculateDistance(start.lat, start.lng, end.lat, end.lng);
            const continentStart = detectContinent(start.lat, start.lng);
            const continentEnd = detectContinent(end.lat, end.lng);
            let routeVariants = [];

            if (d > 3000 && continentStart !== continentEnd) {
              const portA = findNearestPort(start);
              const portB = findNearestPort(end);
              routeVariants.push([
                { m: "Plane", a: start, b: portA },
                { m: "Sea",   a: portA, b: portB },
                { m: "Driving", a: portB, b: end }
              ]);
            } else {
              routeVariants.push([
                { m: "Plane", a: start, b: end }
              ]);
              routeVariants.push([
                { m: "Driving", a: start, b: end }
              ]);
            }

            routeVariants.forEach((segments, routeIdx) => {
              segments.forEach(seg => {
                const md = calculateDistance(seg.a.lat, seg.a.lng, seg.b.lat, seg.b.lng);
                const sp = EMISSION[seg.m].speed;
                const tm = (md/sp).toFixed(2);
                const co = (md*EMISSION[seg.m].factor).toFixed(1);
                const fromStr = `${seg.a.lat.toFixed(3)}, ${seg.a.lng.toFixed(3)}`;
                const toStr = `${seg.b.lat.toFixed(3)}, ${seg.b.lng.toFixed(3)}`;
                const modeStr = `${seg.m} (Option ${routeIdx + 1})`;

                summary.innerHTML += `
                  <tr>
                    <td>${fromStr}</td>
                    <td>${toStr}</td>
                    <td>${modeStr}</td>
                    <td>${md.toFixed(1)}</td>
                    <td>${tm}</td>
                    <td>${co}</td>
                  </tr>`;
                
                const color = seg.m === "Plane" ? "#FF0000" : seg.m === "Sea" ? "#0000FF" : "#008000";
                if (seg.m === "Driving") {
                  routeDriving(seg.a, seg.b, color);
                } else {
                  renderSegment([seg.a, seg.b], color);
                }
              });
            });
          });

          summary.innerHTML += `</table>`;
        });
      }

      document.getElementById("add-stop").addEventListener("click", () => {
        const div = document.createElement("div");
        div.innerHTML = `<input class="waypoint" placeholder="Waypoint"/> <button onclick="this.parentNode.remove()">✕</button>`;
        document.getElementById("waypoints").appendChild(div);
      });
      document.getElementById("go").addEventListener("click", processRoute);

      initMap();
    };
  </script>
</body>
</html>
