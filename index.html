<!DOCTYPE html>
<html>
<head>
  <title>Dynamic Route Optimizer Map</title>
  <meta charset="utf-8"/>
  <meta name="viewport" content="initial-scale=1.0, width=device-width"/>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #map { height: 60vh; width: 100%; margin-top: 10px; margin-bottom: 20px; }
    input, button { padding: 8px; font-size: 16px; margin-right: 10px; }
    .legend span { margin-right: 15px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 10px; text-align: center; white-space: nowrap; }
    th { background-color: #f2f2f2; font-weight: bold; }
  </style>
</head>
<body>
  <h1>Dynamic Route Optimizer Map</h1>
  <div>
    <label>Enter origin:</label><br>
    <input id="origin" placeholder="e.g. Paris, France" style="width: 60%;"/><br><br>
    <label>Enter destination:</label><br>
    <input id="destination" placeholder="e.g. Los Angeles, CA" style="width: 60%;"/><br><br>
    <button id="go">Plot Route</button>
  </div>
  <div class="legend">
    <strong>Legend:</strong>
    <span style="color: red">Plane</span>
    <span style="color: blue">Sea</span>
    <span style="color: green">Drive</span>
  </div>
  <div id="map"></div>
  <div id="summary"></div>

  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBcjGLzmaGgh_cgwoS_2eGas0LD9oQQdDw&libraries=places"></script>
  <script>
    const PORTS = [
      { name: "Port of Le Havre", lat: 49.4949, lng: 0.1079 },
      { name: "Port of New York", lat: 40.7128, lng: -74.0060 },
      { name: "Port of Houston", lat: 29.7560, lng: -95.3678 },
      { name: "Port of Los Angeles", lat: 33.7361, lng: -118.2519 },
      { name: "Port of Rotterdam", lat: 51.9456, lng: 4.1221 },
      { name: "Port of Singapore", lat: 1.2644, lng: 103.8200 }
    ];

    const EMISSION = {
      Plane: { speed: 800, factor: 0.897 },
      Sea: { speed: 35, factor: 0.025 },
      Driving: { speed: 80, factor: 0.432 }
    };

    let map, directionsService, mapRenderers = [];

    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat / 2) ** 2 + Math.cos(lat1 * Math.PI / 180) *
                Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) ** 2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    function findNearestPort(coord) {
      let best = Infinity, nearest = null;
      PORTS.forEach(p => {
        const d = calculateDistance(coord.lat, coord.lng, p.lat, p.lng);
        if (d < best) {
          best = d;
          nearest = p;
        }
      });
      return nearest;
    }

    function detectContinent(lat, lng) {
      if (lng >= -170 && lng <= -30 && lat > 5 && lat < 80) return "NorthAmerica";
      if (lng >= -10 && lng <= 60 && lat > 30 && lat < 75) return "Europe";
      return "Other";
    }

    function clearRoutes() {
      mapRenderers.forEach(r => r.setMap(null));
      mapRenderers = [];
      document.getElementById("summary").innerHTML = "";
    }

    function renderSegment(pathCoords, color) {
      const line = new google.maps.Polyline({
        path: pathCoords, geodesic: true, strokeColor: color,
        strokeOpacity: 1.0, strokeWeight: 3
      });
      line.setMap(map);
      mapRenderers.push(line);
    }

    function routeDriving(a, b, color) {
      const renderer = new google.maps.DirectionsRenderer({
        suppressMarkers: true, polylineOptions: { strokeColor: color }
      });
      renderer.setMap(map);
      directionsService.route({ origin: a, destination: b, travelMode: "DRIVING" }, (res, status) => {
        if (status === "OK") renderer.setDirections(res);
      });
      mapRenderers.push(renderer);
    }

    function processRoute() {
      clearRoutes();
      const geo = new google.maps.Geocoder();
      const origin = document.getElementById("origin").value;
      const dest = document.getElementById("destination").value;
      geo.geocode({ address: origin }, (res1, stat1) => {
        if (stat1 !== "OK") return alert("Origin failed: " + stat1);
        geo.geocode({ address: dest }, (res2, stat2) => {
          if (stat2 !== "OK") return alert("Destination failed: " + stat2);

          const a = res1[0].geometry.location.toJSON();
          const b = res2[0].geometry.location.toJSON();
          const fromCity = res1[0].formatted_address;
          const toCity = res2[0].formatted_address;

          const d = calculateDistance(a.lat, a.lng, b.lat, b.lng);
          const contA = detectContinent(a.lat, a.lng);
          const contB = detectContinent(b.lat, b.lng);

          const portA = findNearestPort(a);
          const portB = findNearestPort(b);

          const routeOptions = [
            [{ m: "Plane", a: a, b: b }],
            [{ m: "Driving", a: a, b: b }]
          ];

          if (d > 3000 && contA !== contB) {
            const driveToPort = calculateDistance(a.lat, a.lng, portA.lat, portA.lng);
            const driveFromPort = calculateDistance(b.lat, b.lng, portB.lat, portB.lng);
            const segments = [];
            if (driveToPort > 20) segments.push({ m: "Driving", a: a, b: portA });
            segments.push({ m: "Sea", a: portA, b: portB });
            if (driveFromPort > 20) segments.push({ m: "Driving", a: portB, b: b });
            routeOptions.push(segments);
          }

          const co2Values = routeOptions.map(opt => opt.reduce((acc, seg) => acc + calculateDistance(seg.a.lat, seg.a.lng, seg.b.lat, seg.b.lng) * EMISSION[seg.m].factor, 0));
          const bestIdx = co2Values.indexOf(Math.min(...co2Values));

          let html = `<h3>Route Summary</h3><table><thead><tr>
            <th>From</th><th>To</th><th>Mode</th><th>Dist (km)</th><th>CO₂ (kg)</th>
            </tr></thead><tbody>`;

          routeOptions.forEach((opt, idx) => {
            opt.forEach(seg => {
              const dist = calculateDistance(seg.a.lat, seg.a.lng, seg.b.lat, seg.b.lng);
              const co2 = dist * EMISSION[seg.m].factor;
              const color = seg.m === "Plane" ? "#FF0000" : seg.m === "Sea" ? "#0000FF" : "#008000";
              if (seg.m === "Driving") routeDriving(seg.a, seg.b, color);
              else renderSegment([seg.a, seg.b], color);
              html += `<tr${idx === bestIdx ? " style='background-color:#ffffe0;'" : ""}>
                  <td>${fromCity}</td><td>${toCity}</td><td>${seg.m} (Option ${idx + 1})${idx === bestIdx ? " ⭐" : ""}</td>
                  <td>${dist.toFixed(1)}</td><td>${co2.toFixed(1)}</td></tr>`;
            });
          });

          html += "</tbody></table>";
          document.getElementById("summary").innerHTML = html;
        });
      });
    }

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        zoom: 4, center: { lat: 39.5, lng: -98 }
      });
      directionsService = new google.maps.DirectionsService();
    }

    document.getElementById("go").addEventListener("click", processRoute);
    window.onload = initMap;
  </script>
</body>
</html>
